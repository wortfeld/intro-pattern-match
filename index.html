<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ffmpeg.wasm PoC – GitHub Pages</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .note { font-size: 13px; color: #333; margin-bottom: 16px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
    button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; background: #f7f7f7; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    #log { white-space: pre-wrap; font-family: Consolas, Menlo, monospace; border: 1px solid #ddd; background: #fafafa; padding: 10px; border-radius: 8px; min-height: 140px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; font-size: 12px; margin-left: 8px; }
  </style>
</head>
<body>
  <h1>ffmpeg.wasm PoC – GitHub Pages</h1>
  <div class="note">
    Place this <code>index.html</code> in your repo root and add:
    <ul>
      <li><code>.nojekyll</code> (empty file)</li>
      <li><code>vendor/ffmpeg/umd/</code> &rarr; copy the entire folder from <code>@ffmpeg/ffmpeg/dist/umd/</code> (must include <code>ffmpeg.js</code> and the numbered chunk like <code>814.ffmpeg.js</code>)</li>
      <li><code>vendor/ffmpeg/core/</code> &rarr; copy all from <code>@ffmpeg/core/dist/</code> (<code>ffmpeg-core.js</code>, <code>ffmpeg-core.wasm</code>, <code>ffmpeg-core.worker.js</code>)</li>
    </ul>
    Then enable GitHub Pages (Deploy from branch). No media upload is needed; files are processed locally in your browser.
  </div>

  <div class="row">
    <button id="btnLoad">1) Load ffmpeg</button>
    <button id="btnVersion" disabled>2) Run -version</button>
    <span id="status" class="pill">not loaded</span>
  </div>

  <div class="row">
    <input id="fileInput" type="file" accept="video/*,audio/*" disabled>
    <button id="btnExtract" disabled>3) Extract 2s WAV</button>
    <a id="downloadLink" style="display:none">download result</a>
  </div>

  <div id="log"></div>

  <!-- UMD bundle (served from your repo). The chunk in the same folder (e.g. 814.ffmpeg.js) is required. -->
  <script src="./vendor/ffmpeg/umd/ffmpeg.js"></script>
  <script>
  (function(){
    var logEl = document.getElementById('log');
    function log(s){ var t=document.createTextNode(s); logEl.appendChild(t); logEl.appendChild(document.createElement('br')); logEl.scrollTop = logEl.scrollHeight; }

    var btnLoad = document.getElementById('btnLoad');
    var btnVersion = document.getElementById('btnVersion');
    var btnExtract = document.getElementById('btnExtract');
    var fileInput = document.getElementById('fileInput');
    var downloadLink = document.getElementById('downloadLink');
    var statusEl = document.getElementById('status');

    var ffmpeg = null;

    window.addEventListener('error', function(e){ log('window error: ' + e.message); });
    window.addEventListener('unhandledrejection', function(e){ var r = e && e.reason ? (e.reason.message || e.reason) : 'unknown'; log('unhandled rejection: ' + r); });

    function toBlobURL(url, mime){
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('fetch failed ' + url + ' (' + r.status + ')'); return r.arrayBuffer(); })
                      .then(function(buf){ return URL.createObjectURL(new Blob([buf], { type: mime })); });
    }

    log('typeof FFmpegWASM = ' + (typeof window.FFmpegWASM));

    btnLoad.addEventListener('click', function(){
      if (!window.FFmpegWASM) { log('FFmpegWASM global missing.'); return; }
      var FFmpegClass = window.FFmpegWASM.FFmpeg;
      ffmpeg = new FFmpegClass();
      ffmpeg.on('log', function(ev){ if (ev && ev.message) log('[ffmpeg] ' + ev.message); });

      statusEl.textContent = 'loading';
      var base = new URL('./vendor/ffmpeg/core/', document.baseURI).href;
      Promise.all([
        toBlobURL(base + 'ffmpeg-core.js', 'text/javascript'),
        toBlobURL(base + 'ffmpeg-core.wasm', 'application/wasm'),
        toBlobURL(base + 'ffmpeg-core.worker.js', 'text/javascript')
      ]).then(function(arr){
        var coreURL = arr[0], wasmURL = arr[1], workerURL = arr[2];
        log('ffmpeg.load with blob URLs');
        return ffmpeg.load({ coreURL: coreURL, wasmURL: wasmURL, workerURL: workerURL });
      }).then(function(){
        log('ffmpeg loaded');
        statusEl.textContent = 'loaded';
        btnVersion.disabled = false;
        btnExtract.disabled = false;
        fileInput.disabled = false;
      }).catch(function(err){
        statusEl.textContent = 'load error';
        log('ffmpeg.load error: ' + err);
      });
    });

    btnVersion.addEventListener('click', function(){
      if (!ffmpeg) { log('ffmpeg not loaded'); return; }
      log('running: ffmpeg -version ...');
      ffmpeg.exec(['-version']).then(function(res){
        log('done (returnCode=' + (res && res.returnCode) + ')');
      }).catch(function(err){ log('run error: ' + err); });
    });

    btnExtract.addEventListener('click', function(){
      if (!ffmpeg) { log('ffmpeg not loaded'); return; }
      var file = fileInput.files && fileInput.files[0];
      if (!file) { log('pick a file first'); return; }
      downloadLink.style.display = 'none';
      downloadLink.removeAttribute('href');
      downloadLink.removeAttribute('download');
      file.arrayBuffer().then(function(buf){
        return ffmpeg.writeFile('in.bin', new Uint8Array(buf));
      }).then(function(){
        log('executing: -t 2 -i in.bin -vn -ac 1 -ar 16000 -sample_fmt s16 out.wav');
        return ffmpeg.exec(['-t','2','-i','in.bin','-vn','-ac','1','-ar','16000','-sample_fmt','s16','out.wav']);
      }).then(function(){
        return ffmpeg.readFile('out.wav');
      }).then(function(data){
        var blob = new Blob([data], { type: 'audio/wav' });
        var url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = 'snippet.wav';
        downloadLink.textContent = 'download result (snippet.wav)';
        downloadLink.style.display = 'inline-block';
        log('ready: you can download snippet.wav');
      }).catch(function(err){ log('extract error: ' + err); })
        .finally(function(){ try { ffmpeg.deleteFile('in.bin'); } catch(_){} try { ffmpeg.deleteFile('out.wav'); } catch(_){} });
    });
  })();
  </script>
</body>
</html>
